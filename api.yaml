openapi: 3.0.3
info:
  title: E-commerce API
  description: FastAPI backend for Next.js e-commerce with Auth0, Paymob, and PostgreSQL
  version: 1.0.0
servers:
  - url: http://localhost:8000/api/v1
    description: Local development server
  - url: https://api.yourstore.com/api/v1
    description: Production server

components:
  securitySchemes:
    Auth0Bearer:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT access token from Auth0. Include in Authorization header as: `Bearer <token>`
        
        Token contains claims:
        - sub: Auth0 user ID
        - email: user email
        - role: user role (customer, moderator, admin)
        - permissions: array of permissions
        
        Token expires in 24 hours. Use /auth/refresh to get new token.
  
  parameters:
    PageParam:
      name: page
      in: query
      schema:
        type: integer
        default: 1
      description: Page number for pagination
    
    LimitParam:
      name: limit
      in: query
      schema:
        type: integer
        default: 20
        maximum: 100
      description: Number of items per page
  
  schemas:
    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: Internal user ID (PostgreSQL)
        auth0_id:
          type: string
          description: Auth0 user ID (from JWT sub claim)
          example: auth0|63f5d9e8a1b2c3d4e5f6g7h8
        email:
          type: string
          format: email
        email_verified:
          type: boolean
          description: Whether email is verified in Auth0
        name:
          type: string
        phone:
          type: string
        address:
          type: object
          properties:
            street:
              type: string
            city:
              type: string
            state:
              type: string
            postal_code:
              type: string
            country:
              type: string
        role:
          type: string
          enum: [customer, moderator, admin]
          description: User role stored in Auth0 app_metadata and JWT claims
        permissions:
          type: array
          items:
            type: string
          description: User permissions from Auth0 (read:items, write:items, etc.)
        last_login:
          type: string
          format: date-time
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    
    Category:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        slug:
          type: string
        description:
          type: string
        parent_id:
          type: string
          format: uuid
          nullable: true
        image_url:
          type: string
        is_active:
          type: boolean
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    
    Item:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        slug:
          type: string
        description:
          type: string
        price:
          type: number
          format: decimal
        compare_at_price:
          type: number
          format: decimal
          nullable: true
        cost:
          type: number
          format: decimal
        sku:
          type: string
        barcode:
          type: string
        quantity:
          type: integer
        category_id:
          type: string
          format: uuid
        images:
          type: array
          items:
            type: string
        is_active:
          type: boolean
        is_featured:
          type: boolean
        weight:
          type: number
        dimensions:
          type: object
          properties:
            length:
              type: number
            width:
              type: number
            height:
              type: number
        metadata:
          type: object
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    
    Review:
      type: object
      properties:
        id:
          type: string
          format: uuid
        item_id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        rating:
          type: integer
          minimum: 1
          maximum: 5
        title:
          type: string
        comment:
          type: string
        images:
          type: array
          items:
            type: string
        verified_purchase:
          type: boolean
        is_approved:
          type: boolean
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    
    Order:
      type: object
      properties:
        id:
          type: string
          format: uuid
        order_number:
          type: string
        user_id:
          type: string
          format: uuid
        status:
          type: string
          enum: [pending, processing, shipped, delivered, cancelled, refunded]
        items:
          type: array
          items:
            type: object
            properties:
              item_id:
                type: string
                format: uuid
              name:
                type: string
              quantity:
                type: integer
              price:
                type: number
              total:
                type: number
        subtotal:
          type: number
        tax:
          type: number
        shipping:
          type: number
        discount:
          type: number
        total:
          type: number
        currency:
          type: string
          default: EGP
        shipping_address:
          type: object
        billing_address:
          type: object
        payment_method:
          type: string
          enum: [card, wallet, cash_on_delivery, kiosk, valu]
          description: Paymob payment method
        payment_status:
          type: string
          enum: [pending, paid, failed, refunded, voided]
        paymob_order_id:
          type: string
          description: Paymob order ID
        paymob_transaction_id:
          type: integer
          description: Paymob transaction ID
        paymob_integration_id:
          type: integer
          description: Paymob integration ID used
        notes:
          type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    
    Analytics:
      type: object
      properties:
        period:
          type: string
          enum: [daily, weekly, monthly, yearly]
        date_from:
          type: string
          format: date
        date_to:
          type: string
          format: date
        total_revenue:
          type: number
        total_orders:
          type: integer
        total_customers:
          type: integer
        average_order_value:
          type: number
        top_products:
          type: array
          items:
            type: object
        revenue_by_category:
          type: array
          items:
            type: object
    
    Error:
      type: object
      properties:
        error:
          type: string
        message:
          type: string
        details:
          type: object

security:
  - Auth0Bearer: []

paths:
  # ============ AUTH0 JWT AUTHENTICATION ============
  /auth/login:
    post:
      summary: Login with email and password
      tags:
        - Authentication
      description: Authenticate user via Auth0 and receive JWT tokens
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
                password:
                  type: string
                  format: password
                  example: SecurePassword123!
      responses:
        '200':
          description: Login successful, JWT tokens issued
          content:
            application/json:
              schema:
                type: object
                properties:
                  access_token:
                    type: string
                    description: JWT access token (expires in 24h)
                    example: eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...
                  refresh_token:
                    type: string
                    description: JWT refresh token (expires in 30 days)
                    example: v1.MXXzYj...
                  token_type:
                    type: string
                    example: Bearer
                  expires_in:
                    type: integer
                    description: Access token expiration time in seconds
                    example: 86400
                  user:
                    $ref: '#/components/schemas/User'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  
  /auth/register:
    post:
      summary: Register new user
      tags:
        - Authentication
      description: Create new user account in Auth0 and database
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
                - name
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
                  format: password
                  description: Minimum 8 characters, requires uppercase, lowercase, number, and special character
                name:
                  type: string
                phone:
                  type: string
      responses:
        '201':
          description: User registered successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  access_token:
                    type: string
                  refresh_token:
                    type: string
                  token_type:
                    type: string
                    example: Bearer
                  expires_in:
                    type: integer
                  user:
                    $ref: '#/components/schemas/User'
        '400':
          description: Validation error or user already exists
  
  /auth/social/login:
    post:
      summary: Initialize social login (Google, Facebook, etc.)
      tags:
        - Authentication
      description: Returns Auth0 authorization URL for social login
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - provider
              properties:
                provider:
                  type: string
                  enum: [google, facebook, apple, twitter]
                  example: google
                redirect_uri:
                  type: string
                  example: https://yourapp.com/auth/callback
      responses:
        '200':
          description: Authorization URL generated
          content:
            application/json:
              schema:
                type: object
                properties:
                  authorization_url:
                    type: string
                    example: https://your-tenant.auth0.com/authorize?response_type=code&client_id=...
                  state:
                    type: string
                    description: CSRF protection state parameter
  
  /auth/callback:
    get:
      summary: OAuth callback endpoint
      tags:
        - Authentication
      description: Handles OAuth callback from Auth0 social login
      security: []
      parameters:
        - name: code
          in: query
          required: true
          schema:
            type: string
          description: Authorization code from Auth0
        - name: state
          in: query
          required: true
          schema:
            type: string
          description: State parameter for CSRF protection
      responses:
        '200':
          description: JWT tokens issued
          content:
            application/json:
              schema:
                type: object
                properties:
                  access_token:
                    type: string
                  refresh_token:
                    type: string
                  token_type:
                    type: string
                    example: Bearer
                  expires_in:
                    type: integer
                  user:
                    $ref: '#/components/schemas/User'
  
  /auth/refresh:
    post:
      summary: Refresh JWT access token
      tags:
        - Authentication
      description: Get new access token using refresh token
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - refresh_token
              properties:
                refresh_token:
                  type: string
                  description: Valid JWT refresh token
      responses:
        '200':
          description: New access token issued
          content:
            application/json:
              schema:
                type: object
                properties:
                  access_token:
                    type: string
                    description: New JWT access token
                  token_type:
                    type: string
                    example: Bearer
                  expires_in:
                    type: integer
                    example: 86400
        '401':
          description: Invalid or expired refresh token
  
  /auth/logout:
    post:
      summary: Logout user
      tags:
        - Authentication
      description: Invalidate JWT tokens and logout from Auth0
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                refresh_token:
                  type: string
                  description: Refresh token to invalidate
      responses:
        '200':
          description: Logged out successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Logged out successfully
  
  /auth/verify:
    get:
      summary: Verify JWT token
      tags:
        - Authentication
      description: Verify if the current JWT access token is valid and decode user info
      responses:
        '200':
          description: Token is valid
          content:
            application/json:
              schema:
                type: object
                properties:
                  valid:
                    type: boolean
                    example: true
                  user:
                    $ref: '#/components/schemas/User'
                  token_claims:
                    type: object
                    properties:
                      sub:
                        type: string
                        description: Auth0 user ID
                      email:
                        type: string
                      email_verified:
                        type: boolean
                      iss:
                        type: string
                        description: Token issuer
                      aud:
                        type: string
                        description: Audience
                      iat:
                        type: integer
                        description: Issued at timestamp
                      exp:
                        type: integer
                        description: Expiration timestamp
                      scope:
                        type: string
                        example: openid profile email
        '401':
          description: Token is invalid or expired
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  
  /auth/password/forgot:
    post:
      summary: Request password reset
      tags:
        - Authentication
      description: Send password reset email via Auth0
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
              properties:
                email:
                  type: string
                  format: email
      responses:
        '200':
          description: Password reset email sent
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Password reset email sent
  
  /auth/password/reset:
    post:
      summary: Reset password
      tags:
        - Authentication
      description: Reset password using token from email
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - token
                - new_password
              properties:
                token:
                  type: string
                  description: Password reset token from email
                new_password:
                  type: string
                  format: password
      responses:
        '200':
          description: Password reset successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Password reset successful
  
  # ============ USERS ============
  /users:
    get:
      summary: List all users (Admin/Moderator only)
      tags:
        - Users
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
        - name: role
          in: query
          schema:
            type: string
            enum: [customer, moderator, admin]
      responses:
        '200':
          description: List of users
          content:
            application/json:
              schema:
                type: object
                properties:
                  users:
                    type: array
                    items:
                      $ref: '#/components/schemas/User'
                  total:
                    type: integer
                  page:
                    type: integer
                  pages:
                    type: integer
    
    post:
      summary: Create a new user (Admin only)
      tags:
        - Users
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - name
              properties:
                email:
                  type: string
                name:
                  type: string
                phone:
                  type: string
                role:
                  type: string
                  enum: [customer, moderator, admin]
      responses:
        '201':
          description: User created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
  
  /users/me:
    get:
      summary: Get current user profile
      tags:
        - Users
      responses:
        '200':
          description: Current user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
    
    put:
      summary: Update current user profile
      tags:
        - Users
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                phone:
                  type: string
                address:
                  type: object
      responses:
        '200':
          description: User updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
  
  /users/{user_id}:
    get:
      summary: Get user by ID (Admin/Moderator only)
      tags:
        - Users
      parameters:
        - name: user_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: User details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
    
    put:
      summary: Update user (Admin only)
      tags:
        - Users
      parameters:
        - name: user_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                email:
                  type: string
                phone:
                  type: string
                role:
                  type: string
                address:
                  type: object
      responses:
        '200':
          description: User updated
    
    delete:
      summary: Delete user (Admin only)
      tags:
        - Users
      parameters:
        - name: user_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: User deleted

  # ============ MODERATORS ============
  /moderators:
    get:
      summary: List all moderators (Admin only)
      tags:
        - Moderators
      responses:
        '200':
          description: List of moderators
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/User'
    
    post:
      summary: Create moderator (Admin only)
      tags:
        - Moderators
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - name
              properties:
                email:
                  type: string
                name:
                  type: string
                permissions:
                  type: array
                  items:
                    type: string
      responses:
        '201':
          description: Moderator created
  
  /moderators/{moderator_id}:
    put:
      summary: Update moderator (Admin only)
      tags:
        - Moderators
      parameters:
        - name: moderator_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                permissions:
                  type: array
                  items:
                    type: string
      responses:
        '200':
          description: Moderator updated
    
    delete:
      summary: Remove moderator role (Admin only)
      tags:
        - Moderators
      parameters:
        - name: moderator_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Moderator removed

  # ============ ADMINS ============
  /admins:
    get:
      summary: List all admins (Admin only)
      tags:
        - Admins
      responses:
        '200':
          description: List of admins
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/User'
    
    post:
      summary: Create admin (Admin only)
      tags:
        - Admins
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - name
              properties:
                email:
                  type: string
                name:
                  type: string
      responses:
        '201':
          description: Admin created
  
  /admins/{admin_id}:
    delete:
      summary: Remove admin (Admin only)
      tags:
        - Admins
      parameters:
        - name: admin_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Admin removed

  # ============ CATEGORIES ============
  /categories:
    get:
      summary: List all categories
      tags:
        - Categories
      parameters:
        - name: parent_id
          in: query
          schema:
            type: string
            format: uuid
        - name: is_active
          in: query
          schema:
            type: boolean
      responses:
        '200':
          description: List of categories
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Category'
    
    post:
      summary: Create category (Admin/Moderator only)
      tags:
        - Categories
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
              properties:
                name:
                  type: string
                description:
                  type: string
                parent_id:
                  type: string
                  format: uuid
                image_url:
                  type: string
      responses:
        '201':
          description: Category created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Category'
  
  /categories/{category_id}:
    get:
      summary: Get category by ID
      tags:
        - Categories
      parameters:
        - name: category_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Category details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Category'
    
    put:
      summary: Update category (Admin/Moderator only)
      tags:
        - Categories
      parameters:
        - name: category_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                description:
                  type: string
                is_active:
                  type: boolean
      responses:
        '200':
          description: Category updated
    
    delete:
      summary: Delete category (Admin only)
      tags:
        - Categories
      parameters:
        - name: category_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Category deleted

  # ============ ITEMS ============
  /items:
    get:
      summary: List all items
      tags:
        - Items
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
        - name: category_id
          in: query
          schema:
            type: string
            format: uuid
        - name: is_active
          in: query
          schema:
            type: boolean
        - name: is_featured
          in: query
          schema:
            type: boolean
        - name: search
          in: query
          schema:
            type: string
        - name: sort_by
          in: query
          schema:
            type: string
            enum: [price_asc, price_desc, name, newest, popular]
      responses:
        '200':
          description: List of items
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/Item'
                  total:
                    type: integer
                  page:
                    type: integer
                  pages:
                    type: integer
    
    post:
      summary: Create item (Admin/Moderator only)
      tags:
        - Items
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
                - price
                - category_id
              properties:
                name:
                  type: string
                description:
                  type: string
                price:
                  type: number
                compare_at_price:
                  type: number
                cost:
                  type: number
                sku:
                  type: string
                quantity:
                  type: integer
                category_id:
                  type: string
                  format: uuid
                images:
                  type: array
                  items:
                    type: string
      responses:
        '201':
          description: Item created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Item'
  
  /items/{item_id}:
    get:
      summary: Get item by ID
      tags:
        - Items
      parameters:
        - name: item_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Item details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Item'
    
    put:
      summary: Update item (Admin/Moderator only)
      tags:
        - Items
      parameters:
        - name: item_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                description:
                  type: string
                price:
                  type: number
                quantity:
                  type: integer
                is_active:
                  type: boolean
      responses:
        '200':
          description: Item updated
    
    delete:
      summary: Delete item (Admin only)
      tags:
        - Items
      parameters:
        - name: item_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Item deleted

  # ============ REVIEWS ============
  /items/{item_id}/reviews:
    get:
      summary: Get reviews for an item
      tags:
        - Reviews
      parameters:
        - name: item_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 10
      responses:
        '200':
          description: List of reviews
          content:
            application/json:
              schema:
                type: object
                properties:
                  reviews:
                    type: array
                    items:
                      $ref: '#/components/schemas/Review'
                  average_rating:
                    type: number
                  total:
                    type: integer
    
    post:
      summary: Create review for an item
      tags:
        - Reviews
      parameters:
        - name: item_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - rating
              properties:
                rating:
                  type: integer
                  minimum: 1
                  maximum: 5
                title:
                  type: string
                comment:
                  type: string
                images:
                  type: array
                  items:
                    type: string
      responses:
        '201':
          description: Review created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Review'
  
  /reviews/{review_id}:
    put:
      summary: Update review (own review or Admin/Moderator)
      tags:
        - Reviews
      parameters:
        - name: review_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                rating:
                  type: integer
                title:
                  type: string
                comment:
                  type: string
      responses:
        '200':
          description: Review updated
    
    delete:
      summary: Delete review (own review or Admin/Moderator)
      tags:
        - Reviews
      parameters:
        - name: review_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Review deleted
  
  /reviews/{review_id}/approve:
    post:
      summary: Approve review (Admin/Moderator only)
      tags:
        - Reviews
      parameters:
        - name: review_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Review approved

  # ============ ORDERS ============
  /orders:
    get:
      summary: List orders (own orders or all for Admin/Moderator)
      tags:
        - Orders
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
        - name: status
          in: query
          schema:
            type: string
        - name: user_id
          in: query
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: List of orders
          content:
            application/json:
              schema:
                type: object
                properties:
                  orders:
                    type: array
                    items:
                      $ref: '#/components/schemas/Order'
                  total:
                    type: integer
    
    post:
      summary: Create order
      tags:
        - Orders
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - items
                - shipping_address
              properties:
                items:
                  type: array
                  items:
                    type: object
                    properties:
                      item_id:
                        type: string
                        format: uuid
                      quantity:
                        type: integer
                shipping_address:
                  type: object
                billing_address:
                  type: object
                notes:
                  type: string
      responses:
        '201':
          description: Order created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Order'
  
  /orders/{order_id}:
    get:
      summary: Get order by ID
      tags:
        - Orders
      parameters:
        - name: order_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Order details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Order'
    
    put:
      summary: Update order (Admin/Moderator only)
      tags:
        - Orders
      parameters:
        - name: order_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                status:
                  type: string
                notes:
                  type: string
      responses:
        '200':
          description: Order updated
    
    delete:
      summary: Cancel order (own order if pending, or Admin)
      tags:
        - Orders
      parameters:
        - name: order_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Order cancelled
  
  /orders/{order_id}/checkout:
    post:
      summary: Checkout and initiate Paymob payment
      tags:
        - Orders
      parameters:
        - name: order_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - payment_method
              properties:
                payment_method:
                  type: string
                  enum: [card, wallet, cash_on_delivery, kiosk, valu]
                  description: Paymob payment integration method
                billing_data:
                  type: object
                  properties:
                    first_name:
                      type: string
                    last_name:
                      type: string
                    email:
                      type: string
                    phone_number:
                      type: string
                    apartment:
                      type: string
                    floor:
                      type: string
                    street:
                      type: string
                    building:
                      type: string
                    city:
                      type: string
                    country:
                      type: string
                    state:
                      type: string
                    postal_code:
                      type: string
      responses:
        '200':
          description: Paymob checkout initiated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  payment_token:
                    type: string
                    description: Paymob payment token for iframe
                  iframe_url:
                    type: string
                    description: Paymob iframe URL for card payments
                  redirect_url:
                    type: string
                    description: Payment redirect URL
                  order_id:
                    type: string
                    format: uuid
                  paymob_order_id:
                    type: string
                    description: Paymob order ID
                  hmac:
                    type: string
                    description: HMAC for verification
        '400':
          description: Invalid payment request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  
  /payments/paymob/callback:
    post:
      summary: Paymob payment callback webhook
      tags:
        - Orders
      description: Webhook endpoint for Paymob payment notifications (transaction processed, accepted, voided, refunded)
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                obj:
                  type: object
                  properties:
                    id:
                      type: integer
                      description: Paymob transaction ID
                    pending:
                      type: boolean
                    amount_cents:
                      type: integer
                    success:
                      type: boolean
                    is_auth:
                      type: boolean
                    is_capture:
                      type: boolean
                    is_standalone_payment:
                      type: boolean
                    is_voided:
                      type: boolean
                    is_refunded:
                      type: boolean
                    is_3d_secure:
                      type: boolean
                    integration_id:
                      type: integer
                    profile_id:
                      type: integer
                    has_parent_transaction:
                      type: boolean
                    order:
                      type: object
                      properties:
                        id:
                          type: integer
                        created_at:
                          type: string
                        delivery_needed:
                          type: boolean
                        merchant:
                          type: object
                        amount_cents:
                          type: integer
                        shipping_data:
                          type: object
                        currency:
                          type: string
                        is_payment_locked:
                          type: boolean
                        merchant_order_id:
                          type: string
                          description: Your order ID
                        items:
                          type: array
                          items:
                            type: object
                    created_at:
                      type: string
                      format: date-time
                    currency:
                      type: string
                    source_data:
                      type: object
                      properties:
                        type:
                          type: string
                        pan:
                          type: string
                        sub_type:
                          type: string
                    api_source:
                      type: string
                    terminal_id:
                      type: string
                    merchant_commission:
                      type: integer
                    installment:
                      type: string
                    discount_details:
                      type: array
                      items:
                        type: object
                    is_void:
                      type: boolean
                    is_refund:
                      type: boolean
                    data:
                      type: object
                      properties:
                        klass:
                          type: string
                        gateway_integration_pk:
                          type: integer
                        merchant:
                          type: string
                        amount:
                          type: integer
                        currency:
                          type: string
                        message:
                          type: string
                        merchant_txn_ref:
                          type: string
                        txn_response_code:
                          type: string
                    is_hidden:
                      type: boolean
                    payment_key_claims:
                      type: object
                      properties:
                        user_id:
                          type: integer
                        amount_cents:
                          type: integer
                        currency:
                          type: string
                        integration_id:
                          type: integer
                        billing_data:
                          type: object
                    error_occured:
                      type: boolean
                    is_live:
                      type: boolean
                    other_endpoint_reference:
                      type: string
                    refunded_amount_cents:
                      type: integer
                    source_id:
                      type: integer
                    is_captured:
                      type: boolean
                    captured_amount:
                      type: integer
                    merchant_staff_tag:
                      type: string
                    owner:
                      type: integer
                    parent_transaction:
                      type: string
                type:
                  type: string
                  enum: [TRANSACTION, TOKEN]
      responses:
        '200':
          description: Callback processed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: success
  
  /payments/paymob/response:
    get:
      summary: Paymob payment response page
      tags:
        - Orders
      description: User redirect endpoint after Paymob payment completion
      security: []
      parameters:
        - name: success
          in: query
          schema:
            type: string
            enum: ['true', 'false']
        - name: id
          in: query
          description: Paymob transaction ID
          schema:
            type: string
        - name: pending
          in: query
          schema:
            type: string
        - name: amount_cents
          in: query
          schema:
            type: string
        - name: merchant_order_id
          in: query
          description: Your order ID
          schema:
            type: string
        - name: order
          in: query
          description: Paymob order ID
          schema:
            type: string
        - name: hmac
          in: query
          description: HMAC for verification
          schema:
            type: string
      responses:
        '200':
          description: Payment status page
          content:
            text/html:
              schema:
                type: string

  # ============ ANALYTICS ============
  /analytics/dashboard:
    get:
      summary: Get dashboard analytics (Admin only)
      tags:
        - Analytics
      parameters:
        - name: period
          in: query
          schema:
            type: string
            enum: [daily, weekly, monthly, yearly]
            default: monthly
        - name: date_from
          in: query
          schema:
            type: string
            format: date
        - name: date_to
          in: query
          schema:
            type: string
            format: date
      responses:
        '200':
          description: Analytics data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Analytics'
  
  /analytics/revenue:
    get:
      summary: Get revenue analytics (Admin only)
      tags:
        - Analytics
      parameters:
        - name: period
          in: query
          schema:
            type: string
            enum: [daily, weekly, monthly, yearly]
        - name: date_from
          in: query
          schema:
            type: string
            format: date
        - name: date_to
          in: query
          schema:
            type: string
            format: date
      responses:
        '200':
          description: Revenue data
          content:
            application/json:
              schema:
                type: object
                properties:
                  total_revenue:
                    type: number
                  revenue_by_period:
                    type: array
                    items:
                      type: object
  
  /analytics/products:
    get:
      summary: Get product analytics (Admin only)
      tags:
        - Analytics
      responses:
        '200':
          description: Product analytics
          content:
            application/json:
              schema:
                type: object
                properties:
                  top_selling:
                    type: array
                    items:
                      type: object
                  low_stock:
                    type: array
                    items:
                      type: object
  
  /analytics/customers:
    get:
      summary: Get customer analytics (Admin only)
      tags:
        - Analytics
      responses:
        '200':
          description: Customer analytics
          content:
            application/json:
              schema:
                type: object
                properties:
                  total_customers:
                    type: integer
                  new_customers:
                    type: integer
                  repeat_customers:
                    type: integer
                  customer_lifetime_value:
                    type: number
  
  /analytics/export:
    post:
      summary: Export analytics data (Admin only)
      tags:
        - Analytics
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                report_type:
                  type: string
                  enum: [revenue, products, customers, orders]
                format:
                  type: string
                  enum: [csv, xlsx, pdf]
                date_from:
                  type: string
                  format: date
                date_to:
                  type: string
                  format: date
      responses:
        '200':
          description: Export file
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary

tags:
  - name: Authentication
    description: Auth0 authentication and authorization endpoints
  - name: Users
    description: User management endpoints (Auth0 integrated)
  - name: Moderators
    description: Moderator management endpoints
  - name: Admins
    description: Admin management endpoints
  - name: Categories
    description: Category management endpoints
  - name: Items
    description: Item/Product management endpoints
  - name: Reviews
    description: Product review endpoints
  - name: Orders
    description: Order management, Paymob checkout, and payment endpoints
  - name: Analytics
    description: Analytics and reporting endpoints
