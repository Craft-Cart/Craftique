rules:
  # ============================================
  # Mass Assignment Detection Rules
  # ============================================
  - id: mass-assignment-prisma-update
    patterns:
      - pattern:  "$PRISMA.$MODEL.update({ data: $DATA, ... })"
      - metavariable-pattern:
          metavariable: $DATA
          pattern: req.body
    message: "Potential mass assignment vulnerability: Using req.body directly in Prisma update. Manually destructure inputs to prevent mass assignment."
    severity: WARNING
    languages: [typescript, javascript]

  - id: mass-assignment-general-update
    patterns:
      - pattern: $OBJ.update($BODY)
      - metavariable-pattern:
          metavariable: $BODY
          pattern: req.body
    message: "Potential mass assignment vulnerability: Passing req.body directly to update method. Use manual destructuring instead."
    severity: WARNING
    languages: [typescript, javascript]

  - id: mass-assignment-prisma-update-spread
    patterns:
      - pattern: "$PRISMA.$MODEL.update({ data: { ...$SPREAD }, ... })"
      - metavariable-pattern:
          metavariable: $SPREAD
          pattern: req.body
    message: "Potential mass assignment vulnerability: Using spread operator with req.body in Prisma update. Manually destructure specific fields instead."
    severity: WARNING
    languages: [typescript, javascript]

  - id: mass-assignment-prisma-create
    patterns:
      - pattern: "$PRISMA.$MODEL.create({ data: $DATA, ... })"
      - metavariable-pattern:
          metavariable: $DATA
          pattern: req.body
    message: "Potential mass assignment vulnerability: Using req.body directly in Prisma create. Manually destructure inputs to prevent mass assignment."
    severity: WARNING
    languages: [typescript, javascript]

  - id: mass-assignment-repository-update
    patterns:
      - pattern: "$REPO.update($ID, $DATA)"
      - metavariable-pattern:
          metavariable: $DATA
          pattern: req.body
    message: "Potential mass assignment vulnerability: Passing req.body directly to repository update method. Manually destructure inputs (e.g., { name: req.body.name }) instead."
    severity: WARNING
    languages: [typescript, javascript]

  - id: mass-assignment-service-update
    patterns:
      - pattern: "$SERVICE.update($ID, $DATA)"
      - metavariable-pattern:
          metavariable: $DATA
          pattern: req.body
    message: "Potential mass assignment vulnerability: Passing req.body directly to service update method. Manually destructure inputs instead."
    severity: WARNING
    languages: [typescript, javascript]

  # ============================================
  # SQL Injection Detection Rules
  # ============================================
  - id: sql-injection-raw-query-string-concat
    patterns:
      - pattern: |
          $QUERY = $SQL + $VAR
      - pattern: |
          $QUERY = $VAR + $SQL
      - pattern: |
          $QUERY = `...${$VAR}...`
      - metavariable-pattern:
          metavariable: $QUERY
          pattern-either:
            - pattern: prisma.$queryRaw(...)
            - pattern: prisma.$executeRaw(...)
            - pattern: $DB.query(...)
            - pattern: $DB.execute(...)
            - pattern: $POOL.query(...)
            - pattern: $CLIENT.query(...)
    message: "SQL Injection vulnerability: String concatenation in SQL query detected. Use parameterized queries with $1, $2 syntax (pg) or ORM binding instead of string concatenation."
    severity: ERROR
    languages: [typescript, javascript]

  - id: sql-injection-template-literal-raw
    patterns:
      - pattern: |
          prisma.$queryRaw`SELECT * FROM $TABLE WHERE id = ${$VAR}`
      - pattern: |
          prisma.$executeRaw`UPDATE $TABLE SET name = ${$VAR}`
      - pattern: |
          $DB.query(`SELECT * FROM $TABLE WHERE id = ${$VAR}`)
      - pattern: |
          $POOL.query(`SELECT * FROM $TABLE WHERE id = ${$VAR}`)
    message: "SQL Injection vulnerability: Template literal interpolation in raw SQL query. Use Prisma.$queryRaw with Prisma.sql template tag and parameterized queries ($1, $2) instead."
    severity: ERROR
    languages: [typescript, javascript]

  - id: sql-injection-prisma-raw-without-sql-tag
    patterns:
      - pattern: |
          prisma.$queryRaw($QUERY)
      - pattern-not-inside: |
          Prisma.sql`...`
      - metavariable-pattern:
          metavariable: $QUERY
          pattern-either:
            - pattern: `...${...}...`
            - pattern: $STR + $VAR
            - pattern: $VAR + $STR
    message: "SQL Injection vulnerability: Raw SQL query without Prisma.sql template tag. Use Prisma.sql template tag for safe parameterized queries."
    severity: ERROR
    languages: [typescript, javascript]

  - id: sql-injection-pg-query-string-concat
    patterns:
      - pattern: |
          $CLIENT.query($QUERY, ...)
      - metavariable-pattern:
          metavariable: $QUERY
          pattern-either:
            - pattern: `...${...}...`
            - pattern: $STR + $VAR
            - pattern: $VAR + $STR
            - pattern: "'" + $VAR + "'"
            - pattern: '"' + $VAR + '"'
    message: "SQL Injection vulnerability: String concatenation in pg query. Use parameterized queries with $1, $2, $3 placeholders instead (e.g., query('SELECT * FROM users WHERE id = $1', [userId]))."
    severity: ERROR
    languages: [typescript, javascript]

  - id: sql-injection-pg-query-missing-params
    patterns:
      - pattern: |
          $CLIENT.query($QUERY)
      - pattern-not: |
          $CLIENT.query($QUERY, [$PARAMS])
      - metavariable-pattern:
          metavariable: $QUERY
          pattern-either:
            - pattern: `...${...}...`
            - pattern: $STR + $VAR
    message: "SQL Injection vulnerability: pg query with string interpolation but no parameter array. Use parameterized queries: query('SELECT * FROM users WHERE id = $1', [userId])."
    severity: ERROR
    languages: [typescript, javascript]

  - id: sql-injection-raw-sql-with-vars
    patterns:
      - pattern: |
          $DB.query($SQL, $VARS)
      - metavariable-pattern:
          metavariable: $SQL
          pattern-either:
            - pattern: `...${...}...`
            - pattern: $STR + $VAR
            - pattern: $VAR + $STR
    message: "SQL Injection vulnerability: SQL query string contains variable interpolation. Use parameterized queries with placeholders ($1, $2) and pass values in parameter array."
    severity: ERROR
    languages: [typescript, javascript]

  - id: insecure-random-math-random
    pattern: Math.random()
    message: "Insecure random number generation: Math.random() is not cryptographically secure. Use crypto.randomBytes() for security tokens, passwords, or any security-sensitive operations."
    severity: ERROR
    languages: [typescript, javascript]

  - id: insecure-cookie-settings
    patterns:
      - pattern: res.cookie($NAME, $VALUE, $OPTIONS)
      - pattern-not-inside: |
          httpOnly: true
      - pattern-not-inside: |
          secure: true
      - pattern-not-inside: |
          sameSite: 'strict'
    message: "Insecure cookie settings: Cookies should be set with httpOnly: true, secure: true, and sameSite: 'strict' to prevent XSS and CSRF attacks. Use setAuthCookie() helper for JWT tokens."
    severity: ERROR
    languages: [typescript, javascript]

  - id: insecure-jwt-verification
    patterns:
      - pattern: jwt.verify($TOKEN, $SECRET)
      - pattern-not-inside: |
          algorithms: ['HS256']
      - pattern-not-inside: |
          algorithms: ['RS256']
    message: "Insecure JWT verification: jwt.verify() should specify algorithms explicitly (e.g., algorithms: ['HS256'] or ['RS256']) to prevent algorithm confusion attacks."
    severity: ERROR
    languages: [typescript, javascript]

  - id: manual-jwt-decoding
    pattern: Buffer.from($PAYLOAD, 'base64').toString()
    message: "Manual JWT decoding detected: Avoid manual JWT decoding. Use proper JWT verification libraries with algorithm specification to prevent security vulnerabilities."
    severity: WARNING
    languages: [typescript, javascript]

  - id: missing-ownership-check
    patterns:
      - pattern: |
          $RESOURCE = await $REPO.findById($ID)
          ...
          return $RESOURCE
      - pattern-not: |
          if ($RESOURCE.owner_id !== req.user.id) {
            ...
          }
      - pattern-not: |
          requireOwnership()
    message: "Potential authorization bypass: Returning resource data without verifying ownership (resource.owner_id === req.user.id). Ensure proper authorization checks before returning sensitive data."
    severity: ERROR
    languages: [typescript, javascript]

  - id: missing-user-filter-query
    patterns:
      - pattern: prisma.$MODEL.findMany(...)
      - pattern-not-inside: |
          where: {
            user_id: req.user.id,
            ...
          }
      - pattern-not-inside: |
          where: {
            owner_id: req.user.id,
            ...
          }
    message: "Potential data leakage: Querying user-specific data without filtering by current user. Add user_id or owner_id filter to prevent unauthorized access."
    severity: WARNING
    languages: [typescript, javascript]