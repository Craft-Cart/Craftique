# Craftique DevSecOps Security Pipeline (Cost-Optimized)
# Implements Defense in Depth security strategy with Shift-Left approach
# Optimized for GitHub Free Tier (2,000 minutes/month for private repos)

name: Security Pipeline

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

# Cancel in-progress runs when a new commit is pushed (saves minutes)
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: "20"
  # GCP Artifact Registry configuration
  GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID || 'craftique-project' }}
  GCP_REGION: ${{ vars.GCP_REGION || 'us-central1' }}
  DOCKER_REGISTRY: ${{ vars.GCP_REGION || 'us-central1' }}-docker.pkg.dev
  ARTIFACT_REPO: ${{vars.ARTIFACT_REPO }}
  BACKEND_IMAGE: backend
  FRONTEND_IMAGE: frontend

permissions:
  contents: read
  security-events: write
  actions: read
  packages: write
  pull-requests: write

jobs:
  # ============================================
  # Stage 1: Quick Security Checks (Secrets + Linting)
  # Combined job to reduce runner startup overhead
  # ============================================
  security-quick-scan:
    name: üîê Quick Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks (Secrets Scan)
        run: |
          docker run --rm -v "${{ github.workspace }}:/repo" zricethezav/gitleaks:latest detect \
            --source="/repo" \
            --verbose \
            --redact \
            --exit-code 1
        continue-on-error: false

      - name: Scan Dockerfiles with Hadolint
        run: |
          docker run --rm -i hadolint/hadolint < Backend/Dockerfile || true
          docker run --rm -i hadolint/hadolint < Frontend/Dockerfile || true

  # ============================================
  # Stage 2: SAST + SCA + License Compliance
  # Runs Semgrep SAST, Trivy SCA, and License scanning
  # ============================================
  code-analysis:
    name: üîç Code & Dependency Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Semgrep SAST
        uses: semgrep/semgrep-action@v1
        with:
          config: p/security-audit,p/owasp-top-ten,p/nodejs,p/typescript
          baseline-ref: ""

      - name: Run Our Semgrep SAST
        uses: semgrep/semgrep-action@v1
        with:
          config: .semgrep.yml
          baseline-ref: ""
          output: semgrep-custom-results.json
        continue-on-error: true

      - name: Upload Custom Semgrep Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: custom-semgrep-results
          path: semgrep-custom-results.json
          retention-days: 30

      - name: Run Trivy FS Scan (SCA + IaC)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "table"
          severity: "CRITICAL,HIGH"
        continue-on-error: true

      # ========== License Compliance Scanning ==========
      - name: Run Trivy License Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "json"
          output: "license-report.json"
          scanners: "license"
        continue-on-error: true

      - name: Generate License Compliance Report
        if: always()
        run: |
          if [ -f license-report.json ]; then
            echo "## üìã License Compliance Report" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Count licenses by type
            TOTAL=$(jq '[.Results[]?.Licenses // [] | .[]] | length' license-report.json)
            echo "**Total Licenses Found:** $TOTAL" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # List all unique licenses
            echo "### License Types Detected" >> $GITHUB_STEP_SUMMARY
            jq -r '[.Results[]?.Licenses // [] | .[] | .Name] | unique | sort | .[] | "- \(.)"' license-report.json >> $GITHUB_STEP_SUMMARY || echo "No licenses detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Check for restricted licenses (GPL, AGPL, etc.)
            echo "### ‚ö†Ô∏è Restricted/Copyleft Licenses Check" >> $GITHUB_STEP_SUMMARY
            RESTRICTED=$(jq -r '[.Results[]?.Licenses // [] | .[] | select(.Name | test("GPL|AGPL|SSPL|Commons Clause"; "i"))] | length' license-report.json)
            
            if [ "$RESTRICTED" -gt 0 ]; then
              echo "‚ùå **Warning:** Found $RESTRICTED package(s) with copyleft licenses" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "| Package | License | Severity |" >> $GITHUB_STEP_SUMMARY
              echo "|---------|---------|----------|" >> $GITHUB_STEP_SUMMARY
              jq -r '.Results[]?.Licenses // [] | .[] | select(.Name | test("GPL|AGPL|SSPL|Commons Clause"; "i")) | "| \(.PkgName // "N/A") | \(.Name) | ‚ö†Ô∏è HIGH |"' license-report.json >> $GITHUB_STEP_SUMMARY || true
            else
              echo "‚úÖ **No copyleft licenses detected**" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Summary by category
            echo "### License Distribution" >> $GITHUB_STEP_SUMMARY
            jq -r '[.Results[]?.Licenses // [] | .[] | .Name] | group_by(.) | map({license: .[0], count: length}) | sort_by(.count) | reverse | .[] | "- **\(.license)**: \(.count) package(s)"' license-report.json >> $GITHUB_STEP_SUMMARY || echo "No license data" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload License Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: license-compliance-report
          path: license-report.json
          retention-days: 90

      - name: Check for Prohibited Licenses
        if: always()
        run: |
          # Fail the build if any prohibited licenses are found
          # Customize this list based on your organization's policy
          PROHIBITED_LICENSES=(
            "AGPL-3.0"
            "GPL-3.0"
            "SSPL-1.0"
            "Commons Clause"
          )

          if [ -f license-report.json ]; then
            for license in "${PROHIBITED_LICENSES[@]}"; do
              COUNT=$(jq -r "[.Results[]?.Licenses // [] | .[] | select(.Name == \"$license\")] | length" license-report.json)
              if [ "$COUNT" -gt 0 ]; then
                echo "‚ùå ERROR: Found $COUNT package(s) with prohibited license: $license"
                jq -r ".Results[]?.Licenses // [] | .[] | select(.Name == \"$license\") | \"  - \(.PkgName // \"Unknown\")\"" license-report.json
              fi
            done
          fi
        continue-on-error: true # Set to false to enforce license compliance

  # ============================================
  # Stage 3: Build & Test (Combined Backend + Frontend)
  # Single job with parallel steps where possible
  # ============================================
  build-and-test:
    name: üî® Build & Test
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [security-quick-scan]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm for Frontend
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('Backend/package-lock.json') }}
          restore-keys: ${{ runner.os }}-npm-

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('Frontend/pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-pnpm-

      # Backend Build & Test
      - name: Install Backend dependencies
        working-directory: Backend
        run: npm ci

      - name: Check validation middleware on write routes
        working-directory: Backend
        run: npm run check-validation

      - name: Generate Prisma Client
        working-directory: Backend
        run: npx prisma generate

      - name: Build Backend
        working-directory: Backend
        run: npm run build

      - name: Test Backend
        working-directory: Backend
        run: npm test -- --passWithNoTests
        env:
          NODE_ENV: test

      # Frontend Build & Test
      - name: Install Frontend dependencies
        working-directory: Frontend
        run: pnpm install --no-frozen-lockfile

      - name: Build Frontend
        working-directory: Frontend
        run: pnpm build
        env:
          NEXT_PUBLIC_API_BASE_URL: http://localhost:8000/api/v1

      - name: Test Frontend
        working-directory: Frontend
        run: pnpm test -- --passWithNoTests
        env:
          NODE_ENV: test

  # ============================================
  # Stage 4: Container Build & Scan (Main branch only)
  # Skip on PRs to save significant time/cost
  # ============================================
  container-security:
    name: üê≥ Container Security
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [build-and-test, code-analysis]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Backend image
        uses: docker/build-push-action@v5
        with:
          context: Backend
          push: false
          load: true
          tags: backend:scan
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Frontend image
        uses: docker/build-push-action@v5
        with:
          context: Frontend
          push: false
          load: true
          tags: frontend:scan
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NEXT_PUBLIC_API_BASE_URL=http://localhost:8000/api/v1

      - name: Scan Backend container
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "backend:scan"
          format: "sarif"
          output: "backend-container.sarif"
          severity: "CRITICAL,HIGH"

      - name: Scan Frontend container
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "frontend:scan"
          format: "sarif"
          output: "frontend-container.sarif"
          severity: "CRITICAL,HIGH"

      - name: Upload Backend container scan
        uses: github/codeql-action/upload-sarif@v4
        if: always() && hashFiles('backend-container.sarif') != ''
        with:
          sarif_file: "backend-container.sarif"
          category: "container-backend"

      - name: Upload Frontend container scan
        uses: github/codeql-action/upload-sarif@v4
        if: always() && hashFiles('frontend-container.sarif') != ''
        with:
          sarif_file: "frontend-container.sarif"
          category: "container-frontend"

      # Generate SBOM in same job to avoid extra runner
      - name: Generate Backend SBOM
        uses: anchore/sbom-action@v0
        with:
          image: backend:scan
          format: cyclonedx-json
          output-file: backend-sbom.json

      - name: Generate Frontend SBOM
        uses: anchore/sbom-action@v0
        with:
          image: frontend:scan
          format: cyclonedx-json
          output-file: frontend-sbom.json

      # ========== Container License Scanning ==========
      - name: Scan Backend container licenses
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "backend:scan"
          format: "json"
          output: "backend-container-licenses.json"
          scanners: "license"
        continue-on-error: true

      - name: Scan Frontend container licenses
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "frontend:scan"
          format: "json"
          output: "frontend-container-licenses.json"
          scanners: "license"
        continue-on-error: true

      - name: Analyze Container License Compliance
        if: always()
        run: |
          echo "## üê≥ Container License Compliance" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Backend licenses
          if [ -f backend-container-licenses.json ]; then
            BACKEND_TOTAL=$(jq '[.Results[]?.Licenses // [] | .[]] | length' backend-container-licenses.json)
            echo "**Backend Container Licenses:** $BACKEND_TOTAL" >> $GITHUB_STEP_SUMMARY
          fi

          # Frontend licenses
          if [ -f frontend-container-licenses.json ]; then
            FRONTEND_TOTAL=$(jq '[.Results[]?.Licenses // [] | .[]] | length' frontend-container-licenses.json)
            echo "**Frontend Container Licenses:** $FRONTEND_TOTAL" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Upload SBOM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sbom-artifacts
          path: "*-sbom.json"
          retention-days: 30

      - name: Upload Container License Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: container-license-reports
          path: "*-container-licenses.json"
          retention-days: 30

  # ============================================
  # Stage 5: DAST (Main branch only, after deploy)
  # Most expensive - only run on releases
  # ============================================
  dast-scan:
    name: üåê DAST Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [container-security]
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: craftique
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: craftique
        ports:
          - 5432:5432
        options: --health-cmd pg_isready --health-interval 5s --health-timeout 3s --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: Backend/package-lock.json

      - name: Setup and start Backend
        working-directory: Backend
        run: |
          npm ci
          npx prisma generate
          npm run build
          npx prisma db push --accept-data-loss
          NODE_ENV=production node dist/server.js &
        env:
          DATABASE_URL: postgresql://craftique:test_password@localhost:5432/craftique?schema=public
          PORT: 8000
          JWT_SECRET: test-secret
          COOKIE_SECRET: test-cookie
          AUTH0_DOMAIN: test.auth0.com
          AUTH0_CLIENT_ID: test
          AUTH0_CLIENT_SECRET: test
          AUTH0_AUDIENCE: https://api.test.com
          PAYMOB_API_KEY: test-paymob-key
          PAYMOB_HMAC_SECRET: test-paymob-hmac-secret
          FRONTEND_URL: http://localhost:3000

      - name: Wait for Backend to be ready
        run: |
          echo "Waiting for server to start..."
          timeout 60 bash -c 'until curl -f http://localhost:8000/health; do sleep 2; done' || exit 1
          echo "Server is ready!"

      - name: OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: "http://localhost:8000/health"
          allow_issue_writing: false
        continue-on-error: true

      - name: Upload ZAP Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-report
          path: report_html.html
          retention-days: 14

  # ============================================
  # Stage 6: Security Gate & PR Comment
  # ============================================
  security-gate:
    name: üö¶ Security Gate
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [security-quick-scan, code-analysis, build-and-test]
    if: always()
    steps:
      - name: Evaluate security results
        run: |
          echo "üîê Security Pipeline Summary"
          echo "============================"
          echo "Quick Scan: ${{ needs.security-quick-scan.result }}"
          echo "Code Analysis: ${{ needs.code-analysis.result }}"
          echo "Build & Test: ${{ needs.build-and-test.result }}"

          if [ "${{ needs.security-quick-scan.result }}" == "failure" ]; then
            echo "‚ùå CRITICAL: Secrets detected!"
            exit 1
          fi

          if [ "${{ needs.build-and-test.result }}" == "failure" ]; then
            echo "‚ùå Build or tests failed!"
            exit 1
          fi

          echo "‚úÖ Security gate passed"

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            // Read custom Semgrep results
            let customFindings = { results: [] };
            try {
              const fs = require('fs');
              if (fs.existsSync('semgrep-custom-results.json')) {
                const data = fs.readFileSync('semgrep-custom-results.json', 'utf8');
                customFindings = JSON.parse(data);
              }
            } catch (error) {
              console.log('Could not read custom Semgrep results:', error.message);
            }

            // Count findings by severity
            const findings = customFindings.results || [];
            const errorCount = findings.filter(f => f.extra.severity === 'ERROR').length;
            const warningCount = findings.filter(f => f.extra.severity === 'WARNING').length;
            const infoCount = findings.filter(f => f.extra.severity === 'INFO').length;

            // Create detailed comment
            let comment = `## üõ°Ô∏è Security Summary
            | Check | Status |
            |-------|--------|
            | Secrets Scan | ${{ needs.security-quick-scan.result == 'success' && '‚úÖ' || '‚ùå' }} |
            | SAST/SCA | ${{ needs.code-analysis.result == 'success' && '‚úÖ' || '‚ö†Ô∏è' }} |
            | Build & Test | ${{ needs.build-and-test.result == 'success' && '‚úÖ' || '‚ùå' }} |

            ### üìã Custom Security Rules Results
            | Severity | Count |
            |----------|-------|
            | Errors | ${errorCount} |
            | Warnings | ${warningCount} |
            | Info | ${infoCount} |`;

            if (findings.length > 0) {
              comment += '\n\n### üö® Custom Security Findings\n';
              comment += '| Rule | File | Line | Message |\n';
              comment += '|------|------|------|---------|\n';

              findings.slice(0, 10).forEach(finding => {
                const rule = finding.check_id.split('.').pop();
                const file = finding.path.split('/').pop();
                const line = finding.start.line;
                const message = finding.extra.message.substring(0, 80) + (finding.extra.message.length > 80 ? '...' : '');
                comment += `| ${rule} | ${file} | ${line} | ${message} |\n`;
              });

              if (findings.length > 10) {
                comment += `\n*... and ${findings.length - 10} more findings*\n`;
              }

              comment += '\nüìé **Full results available in:** `custom-semgrep-results` artifact\n';
            } else {
              comment += '\n‚úÖ **No custom security rule violations found!**\n';
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # ============================================
  # Stage 7: Build, Sign & Push with Supply Chain Security
  # Implements: Image signing (cosign), SLSA Provenance, Digest pinning
  # ============================================
  supply-chain-security:
    name: üîè Supply Chain Security
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [security-gate, container-security]
    if: github.event_name == 'push' && github.ref == 'refs/heads/master' && needs.security-gate.result == 'success'
    environment: production
    permissions:
      contents: read
      packages: write
      id-token: write # Required for cosign keyless signing
      attestations: write # Required for SLSA provenance
    outputs:
      backend-digest: ${{ steps.build-backend.outputs.digest }}
      frontend-digest: ${{ steps.build-frontend.outputs.digest }}
      backend-image: ${{ steps.set-outputs.outputs.backend-image }}
      frontend-image: ${{ steps.set-outputs.outputs.frontend-image }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install cosign
        uses: sigstore/cosign-installer@v3.7.0

      # Authenticate to GCP using Workload Identity Federation (keyless)
      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Login to GCP Artifact Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: _json_key
          password: ${{ secrets.GCP_SA_KEY }}

      # ========== Backend Image ==========
      - name: Build and push Backend
        id: build-backend
        uses: docker/build-push-action@v5
        with:
          context: Backend
          push: true
          tags: |
            ${{ env.DOCKER_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/${{ env.BACKEND_IMAGE }}:${{ github.sha }}
            ${{ env.DOCKER_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/${{ env.BACKEND_IMAGE }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: true
          sbom: true

      - name: Sign Backend image with cosign (keyless)
        env:
          DIGEST: ${{ steps.build-backend.outputs.digest }}
          TAGS: ${{ env.DOCKER_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/${{ env.BACKEND_IMAGE }}
        run: |
          echo "Signing backend image..."
          cosign sign --yes "${TAGS}@${DIGEST}"

      - name: Generate Backend SLSA Provenance Attestation
        uses: actions/attest-build-provenance@v2
        with:
          subject-name: ${{ env.DOCKER_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/${{ env.BACKEND_IMAGE }}
          subject-digest: ${{ steps.build-backend.outputs.digest }}
          push-to-registry: true

      - name: Generate Backend SBOM Attestation
        uses: actions/attest-sbom@v2
        with:
          subject-name: ${{ env.DOCKER_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/${{ env.BACKEND_IMAGE }}
          subject-digest: ${{ steps.build-backend.outputs.digest }}
          sbom-path: backend-sbom.json
          push-to-registry: true
        continue-on-error: true

      # ========== Frontend Image ==========
      - name: Build and push Frontend
        id: build-frontend
        uses: docker/build-push-action@v5
        with:
          context: Frontend
          push: true
          tags: |
            ${{ env.DOCKER_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/${{ env.FRONTEND_IMAGE }}:${{ github.sha }}
            ${{ env.DOCKER_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/${{ env.FRONTEND_IMAGE }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NEXT_PUBLIC_API_BASE_URL=${{ vars.NEXT_PUBLIC_API_BASE_URL || 'https://craftique.chickenkiller.com/api/v1' }}
          provenance: true
          sbom: true

      - name: Sign Frontend image with cosign (keyless)
        env:
          DIGEST: ${{ steps.build-frontend.outputs.digest }}
          TAGS: ${{ env.DOCKER_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/${{ env.FRONTEND_IMAGE }}
        run: |
          echo "Signing frontend image..."
          cosign sign --yes "${TAGS}@${DIGEST}"

      - name: Generate Frontend SLSA Provenance Attestation
        uses: actions/attest-build-provenance@v2
        with:
          subject-name: ${{ env.DOCKER_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/${{ env.FRONTEND_IMAGE }}
          subject-digest: ${{ steps.build-frontend.outputs.digest }}
          push-to-registry: true

      - name: Generate Frontend SBOM Attestation
        uses: actions/attest-sbom@v2
        with:
          subject-name: ${{ env.DOCKER_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/${{ env.FRONTEND_IMAGE }}
          subject-digest: ${{ steps.build-frontend.outputs.digest }}
          sbom-path: frontend-sbom.json
          push-to-registry: true
        continue-on-error: true

      # ========== Outputs for GitOps ==========
      - name: Set image outputs
        id: set-outputs
        env:
          FULL_BACKEND: ${{ env.DOCKER_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/${{ env.BACKEND_IMAGE }}
          FULL_FRONTEND: ${{ env.DOCKER_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/${{ env.FRONTEND_IMAGE }}
        run: |
          echo "backend-image=${FULL_BACKEND}@${{ steps.build-backend.outputs.digest }}" >> $GITHUB_OUTPUT
          echo "frontend-image=${FULL_FRONTEND}@${{ steps.build-frontend.outputs.digest }}" >> $GITHUB_OUTPUT

      - name: Verify Backend signature
        env:
          FULL_IMAGE: ${{ env.DOCKER_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/${{ env.BACKEND_IMAGE }}
        run: |
          cosign verify \
            --certificate-identity-regexp="https://github.com/${{ github.repository }}/*" \
            --certificate-oidc-issuer="https://token.actions.githubusercontent.com" \
            ${FULL_IMAGE}@${{ steps.build-backend.outputs.digest }}

      - name: Verify Frontend signature
        env:
          FULL_IMAGE: ${{ env.DOCKER_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/${{ env.FRONTEND_IMAGE }}
        run: |
          cosign verify \
            --certificate-identity-regexp="https://github.com/${{ github.repository }}/*" \
            --certificate-oidc-issuer="https://token.actions.githubusercontent.com" \
            ${FULL_IMAGE}@${{ steps.build-frontend.outputs.digest }}

      - name: Supply Chain Summary
        env:
          FULL_BACKEND: ${{ env.DOCKER_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/${{ env.BACKEND_IMAGE }}
          FULL_FRONTEND: ${{ env.DOCKER_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/${{ env.FRONTEND_IMAGE }}
        run: |
          echo "## üîè Supply Chain Security Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Backend Image" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: \`${FULL_BACKEND}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Digest**: \`${{ steps.build-backend.outputs.digest }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Signed**: ‚úÖ Cosign keyless" >> $GITHUB_STEP_SUMMARY
          echo "- **Provenance**: ‚úÖ SLSA Build L3" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Frontend Image" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: \`${FULL_FRONTEND}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Digest**: \`${{ steps.build-frontend.outputs.digest }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Signed**: ‚úÖ Cosign keyless" >> $GITHUB_STEP_SUMMARY
          echo "- **Provenance**: ‚úÖ SLSA Build L3" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Verification Commands" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Verify backend signature" >> $GITHUB_STEP_SUMMARY
          echo "cosign verify --certificate-identity-regexp='https://github.com/${{ github.repository }}/*' --certificate-oidc-issuer='https://token.actions.githubusercontent.com' ${FULL_BACKEND}@${{ steps.build-backend.outputs.digest }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Verify frontend signature" >> $GITHUB_STEP_SUMMARY
          echo "cosign verify --certificate-identity-regexp='https://github.com/${{ github.repository }}/*' --certificate-oidc-issuer='https://token.actions.githubusercontent.com' ${FULL_FRONTEND}@${{ steps.build-frontend.outputs.digest }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # # ============================================
  # # Stage 8: Update GitOps Manifests with Signed Digests
  # # ============================================
  # update-gitops:
  #   name: üì¶ Update GitOps Manifests
  #   runs-on: ubuntu-latest
  #   needs: [supply-chain-security]
  #   if: github.event_name == 'push' && github.ref == 'refs/heads/master'
  #   steps:
  #     - name: Checkout GitOps repo
  #       uses: actions/checkout@v4
  #       with:
  #         repository: ${{ github.repository_owner }}/craftique-gitops-manifests
  #         token: ${{ secrets.GITOPS_PAT || secrets.GITHUB_TOKEN }}
  #         path: gitops

  #     - name: Update image digests in manifests
  #       run: |
  #         cd gitops

  #         # Update backend deployment with signed digest
  #         sed -i "s|image: .*craftique-backend.*|image: ${{ needs.supply-chain-security.outputs.backend-image }}|g" apps/backend/backend-deployment.yaml

  #         # Update frontend deployment with signed digest
  #         sed -i "s|image: .*craftique-frontend.*|image: ${{ needs.supply-chain-security.outputs.frontend-image }}|g" apps/frontend/frontend-deplyment.yaml

  #         echo "Updated manifests:"
  #         grep -r "image:" apps/

  #     - name: Commit and push changes
  #       run: |
  #         cd gitops
  #         git config user.name "GitHub Actions"
  #         git config user.email "actions@github.com"
  #         git add -A
  #         git diff --staged --quiet || git commit -m "chore: update images to signed digests [skip ci]

  #         Backend: ${{ needs.supply-chain-security.outputs.backend-image }}
  #         Frontend: ${{ needs.supply-chain-security.outputs.frontend-image }}

  #         Triggered by: ${{ github.sha }}"
  #         git push
